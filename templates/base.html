<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{{ title or "SIEST" }}</title>

    <!-- A√±adido: Bootstrap 5 CSS (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- A√±adido: CSS personalizado separado -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- HEADER / NAV -->
    <div class="header">
      {% if current_user.is_authenticated %}
      <div class="header__left">
        <a class="brand-link" href="/">
          <div class="brand-logo" role="img" aria-label="Logo"></div>
          <div class="brand-meta">
            <span class="brand-name">SIEST</span>
            <span class="brand-sub">Gesti√≥n integral</span>
          </div>
        </a>
      </div>

      <div class="header__right">
        <div class="user-chip" aria-label="Datos del usuario">
          <div class="user-avatar">
            {{ (current_user.name or 'U')[:1]|upper }}{{ (current_user.lastname
            or 'S')[:1]|upper }}
          </div>
          <div class="user-meta">
            <span class="user-name"
              >{{ current_user.name }} {{ current_user.lastname }}</span
            >
            <span class="user-id"
              >{{ current_user.codcas or 'Sin c√≥digo' }}</span
            >
          </div>
          <span class="role-chip">{{ current_user.role|capitalize }}</span>
        </div>

        <div class="header__actions">
          <a class="pill-btn pill-btn--ghost" href="/">Inicio</a>
          <a
            class="pill-btn pill-btn--ghost"
            href="{{ url_for('main.change_password') }}"
            >Cambiar contrase√±a</a
          >
          {% if current_user.role == 'admin' %}
          <a
            class="pill-btn pill-btn--ghost"
            href="{{ url_for('main.register') }}"
            >Agregar usuario</a
          >
          <a
            class="pill-btn pill-btn--ghost"
            href="{{ url_for('main.manage_users') }}"
            >Gesti√≥n de usuarios</a
          >
          {% endif %}
          <a class="pill-btn pill-btn--ghost" href="/logout">Cerrar sesi√≥n</a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- MENSAJES FLASH (ahora centrados en la parte superior) -->
    {% with messages = get_flashed_messages(with_categories=True) %} {% if
    messages %}
    <div class="flash-container" aria-live="polite" aria-atomic="true">
      {% for category, msg in messages %} {% if category == 'danger' %} {% set
      cls = 'danger' %} {% elif category == 'warning' %} {% set cls = 'warning'
      %} {% elif category == 'success' %} {% set cls = 'success' %} {% else %}
      {% set cls = 'info' %} {% endif %}
      <div
        class="alert alert-{{ cls }} alert-dismissible fade show flash-floating"
        role="alert"
      >
        {{ msg }}
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <!-- CONTENIDO PRINCIPAL -->
    {% if current_user.is_authenticated %} {% if show_modules|default(True) %}

    <div class="main">
      {% if current_user.role != 'user' %}
      <div class="modules-section">
        <form
          class="codcas-selector"
          method="post"
          action="{{ url_for('main.index') }}"
        >
          {% set limit_centers_to_red = current_user.role == 'admin_red' and current_user.code_red is not none %}
          {% set show_red_selector = current_user.role in ['admin', 'consulta'] %}
          <div class="d-flex align-items-center mb-3">
            <img
              src="{{ url_for('static', filename='SIEST.png') }}"
              alt="Logo centro"
              style="background-color: #0064af"
            />
            <div>
              <h2>Seleccione un centro</h2>
              {% if limit_centers_to_red %}
              <p class="text-muted mb-0 small">
                Elija el centro para ver los m√≥dulos disponibles de su red {{
                current_user.code_red }}
              </p>
              {% else %}
              <p class="text-muted mb-0 small">
                Elija el centro para ver los m√≥dulos disponibles
              </p>
              {% endif %}
            </div>
          </div>
          {% if show_red_selector %}
          <div class="form-group mb-3">
            <label for="code_red_filter" class="form-label" style="font-weight: 500"
              >Red asistencial</label
            >
            <select
              id="code_red_filter"
              name="code_red_filter"
              class="form-select form-select-lg"
              style="border-radius: 0.7rem; width: 100%"
              data-placeholder="Buscar red..."
            >
              <option value="">Todas las redes...</option>
              {% for red in red_options|default([]) %}
              <option value="{{ red.code }}">{{ red.label }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="form-group mb-0">
            <label for="codcas" class="form-label" style="font-weight: 500"
              >Centro asistencial</label
            >
            {% if limit_centers_to_red %}
            <select
              id="codcas"
              name="codcas"
              class="form-select form-select-lg"
              required
              style="border-radius: 0.7rem; width: 100%"
              data-placeholder="Buscar centro..."
            >
              <option value="">Seleccionar centro...</option>
              {% for centro in centros_asistenciales_by_code_red %}
              <option value="{{ centro.cenasicod }}">
                {{ centro.cenasides }}
              </option>
              {% endfor %}
            </select>
            {% else %}
            <select
              id="codcas"
              name="codcas"
              class="form-select form-select-lg"
              required
              style="border-radius: 0.7rem; width: 100%"
              data-placeholder="Buscar centro..."
            >
              <option value="">Seleccionar centro...</option>
              {% for centro in centros_asistenciales %}
              <option value="{{ centro.cenasicod }}">
                {{ centro.cenasides }}
              </option>
              {% endfor %}
            </select>
            {% endif %}
            <!-- Bot√≥n selecci√≥n -->
            <div class="register-submit">
              <button type="submit" id="btn-seleccionar-centro">
                Seleccione un centro
              </button>
            </div>
          </div>
        </form>
      </div>
      {% endif %}

      <div class="modules-container">
        <div class="modules-header" style="color: #ffffff">
          {% if getNombreCentroAsistencial() %}
          <h1 class="modules-titles">
            El centro elegido es {{ getNombreCentroAsistencial() }}
          </h1>
          {% endif %}

          <h1 class="modules-title">M√≥dulos disponibles</h1>
          <p class="modules-subtitle">
            Accede a los diferentes servicios de la plataforma
          </p>
        </div>
        <div class="modules-menu">
          <!-- M√≥dulo 1: Dashboard (activo) -->

          <a
            href="{{ '/ce/' + dashboard_code_for_user() }}"
            class="module"
          >
            <img
              src="{{ url_for('static', filename='RCS2.png') }}"
              alt="Dashboard"
            />
            <span>Consulta externa</span>
          </a>

          <!-- M√≥dulo 2: Emergencia (activar si existe c√≥digo del usuario) -->
          {% set code_alt = current_user.dashboard_code() if current_user else
          '' %} {% if code_alt %}
          <a
            href="{{ '/dashboard_alt/' + dashboard_code_for_user() + '/' }}"
            class="module"
          >
            <img
              src="{{ url_for('static', filename='RSC1.png') }}"
              alt="Emergencia"
            />
            <span>Emergencia</span>
          </a>
          {% else %}
          <div class="module inactive">
            <img
              src="{{ url_for('static', filename='RSC1.png') }}"
              alt="M√≥dulo 2"
            />
            <span>Emergencia</span>
          </div>
          {% endif %}

          <!-- M√≥dulo 4: Laboratorio (desactivado) -->
          <div class="module inactive">
            <img
              src="{{ url_for('static', filename='cirugia.png') }}"
              alt="Centro quir√∫rgico"
            />
            <span>Centro quir√∫rgico</span>
          </div>

          <!-- M√≥dulo 3: Hospitalizaci√≥n (desactivado) -->
          <div class="module inactive">
            <img
              src="{{ url_for('static', filename='hospitalizacion.png') }}"
              alt="Hospitalizaci√≥n"
            />
            <span>Procedimientos</span>
          </div>


          <!-- M√≥dulo 5: reportes gerenciales -->
          {% if current_user.role in ['admin', 'admin_red', 'consulta'] %}
          <a href="{{ url_for('main.reportes_gerenciales') }}" class="module">
            <img
              src="{{ url_for('static', filename='analytics.png') }}"
              alt="Reportes gerenciales"
            />
            <span>Reportes gerenciales</span>
          </a>
          {% endif %}

          <!-- M√≥dulo 6: reportes LOGS - ADMIN -->
          {% if current_user.role == 'admin' %}
          <a href="{{ url_for('logs.view_logs') }}" class="module">
            <img
              src="{{ url_for('static', filename='logs.png') }}"
              alt="Reportes LOGS"
            />

            <span>Auditor√≠a del Sistema</span>
          </a>
          {% endif %}

          <!-- M√≥dulo 7: reporteador -->
          {% if current_user.role == 'admin' %}
          <a href="{{ url_for('main.dashboard_diag_admin') }}" class="module">
            <img
              src="{{ url_for('static', filename='Documento.png') }}"
              alt="Reporteador"
            />

            <span>Reporteador</span>
          </a>
          {% endif %}

          <!-- Los gr√°ficos de auditor√≠a ahora est√°n integrados en Reportes LOGS -->
        </div>
      </div>
    </div>

    {% endif %} {% else %}

    <div class="main">
      <!-- logo superior derecho en pantalla de login -->
      <div class="login-top-logo" role="img" aria-label="Logoes"></div>

      <!-- LOGIN FORM con logo a la izquierda-centro -->
      <div class="login-wrapper">
        <div class="login-logo">
          <img
            src="{{ url_for('static', filename='SIEST.png') }}"
            alt="SIEST - Sistema Integral de Estad√≠sticas"
          />
        </div>
        <div class="container">
          <h2>üîê Acceso</h2>
          <p class="small">
            Ingresa tus credenciales para acceder a la plataforma
          </p>
          <form method="post" action="/login" novalidate>
            <!-- Campo Usuario -->
            <div class="field" aria-hidden="false">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M3.6 20.4a8.4 8.4 0 0 1 16.8 0"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <div class="input-wrap">
                <input
                  type="text"
                  name="username"
                  placeholder="Usuario"
                  aria-label="Usuario"
                  autocomplete="username"
                  required
                />
              </div>
            </div>

            <!-- Campo Contrase√±a -->
            <div class="field">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <rect
                  x="3"
                  y="11"
                  width="18"
                  height="10"
                  rx="2"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M7 11V8a5 5 0 0 1 10 0v3"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <div class="input-wrap">
                <input
                  type="password"
                  name="password"
                  placeholder="Contrase√±a"
                  aria-label="Contrase√±a"
                  autocomplete="current-password"
                  required
                />
              </div>
            </div>

            <!-- Controles -->
            <div class="controls">
              <label>
                <input
                  type="checkbox"
                  name="remember"
                  aria-label="Recordarme en este navegador"
                />
                <span>Recordarme</span>
              </label>
            </div>

            <!-- Bot√≥n Ingresar -->
            <button type="submit">Ingresar ‚Üí</button>

            <!-- Enlace de soporte -->
            <div class="secondary-link">
              ¬øNecesitas ayuda? <strong>Contacta con soporte</strong>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %} {% block body %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery para Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      $(document).ready(function () {
        var $codcas = $("#codcas");
        var $redFilter = $("#code_red_filter");
        var centersEndpointTemplate = {{ url_for('main.centros_by_red_api', code_red='__CODE__')|tojson }};
        var defaultCentersRaw = {{ centros_asistenciales|default([])|tojson }};

        function normalizeCenters(list) {
          if (!Array.isArray(list)) {
            return [];
          }
          return list
            .map(function (item) {
              var code = String(item.code || item.cenasicod || '').trim();
              var label = String(item.label || item.cenasides || '').trim();
              if (!code || !label) {
                return null;
              }
              return { code: code, label: label };
            })
            .filter(Boolean);
        }

        var normalizedDefaults = normalizeCenters(defaultCentersRaw);

        function initSelect2($element) {
          if (!$element.length) {
            return;
          }
          var placeholder = $element.data('placeholder') || 'Seleccionar...';
          $element.select2({
            width: '100%',
            placeholder: placeholder,
            allowClear: false,
          });
        }

        function setCenterOptions(options) {
          if (!$codcas.length) {
            return;
          }
          var selectEl = $codcas.get(0);
          var placeholder = $codcas.data('placeholder') || 'Seleccionar centro...';
          selectEl.innerHTML = '';
          var placeholderOption = new Option(placeholder, '', true, true);
          selectEl.appendChild(placeholderOption);
          normalizeCenters(options).forEach(function (option) {
            var optionNode = new Option(option.label, option.code, false, false);
            selectEl.appendChild(optionNode);
          });
          $codcas.val('').trigger('change.select2');
        }

        function toggleCenterDisabled(isDisabled) {
          if (!$codcas.length) {
            return;
          }
          $codcas.prop('disabled', isDisabled);
          var container = $codcas.next('.select2-container');
          if (container.length) {
            container.toggleClass('is-loading', isDisabled);
          }
        }

        async function loadCentersByRed(codeRed) {
          if (!$codcas.length) {
            return;
          }
          if (!codeRed) {
            setCenterOptions(normalizedDefaults);
            toggleCenterDisabled(false);
            return;
          }
          toggleCenterDisabled(true);
          try {
            var endpoint = centersEndpointTemplate.replace('__CODE__', encodeURIComponent(codeRed));
            var response = await fetch(endpoint);
            if (!response.ok) {
              throw new Error('Respuesta inv√°lida');
            }
            var data = await response.json();
            setCenterOptions(data.centers || []);
          } catch (error) {
            console.warn('No se pudieron cargar los centros para la red seleccionada.', error);
            setCenterOptions(normalizedDefaults);
          } finally {
            toggleCenterDisabled(false);
          }
        }

        initSelect2($codcas);
        initSelect2($redFilter);

        if ($redFilter.length) {
          $redFilter.on('change', function () {
            var selectedRed = ($(this).val() || '').trim();
            loadCentersByRed(selectedRed);
          });
        }
      });
    </script>
  </body>
</html>
